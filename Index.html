<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Azrael Battle - Undertale</title>
  <style>
    body {
      margin: 0;
      background-color: black;
      overflow: hidden;
      font-family: 'Courier New', Courier, monospace;
    }
    #gameCanvas {
      display: block;
      margin: 0 auto;
      background-color: #000;
      border: 2px solid white;
    }
    #startButton {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 24px;
      padding: 10px 20px;
      background: white;
      color: black;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="640" height="480"></canvas>
  <button id="startButton">Начать битву</button>
  <audio id="battleMusic" loop>
    <source src="https://vgmsite.com/soundtracks/undertale-complete/whbxkkndhk/071%20Hopes%20and%20Dreams.mp3" type="audio/mpeg">
  </audio>
  <audio id="saveTheWorldMusic" loop>
    <source src="https://vgmsite.com/soundtracks/undertale-complete/whbxkkndhk/075%20Save%20the%20World.mp3" type="audio/mpeg">
  </audio>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const startButton = document.getElementById("startButton");
    const battleMusic = document.getElementById("battleMusic");
    const saveTheWorldMusic = document.getElementById("saveTheWorldMusic");

    let gameStarted = false;
    let frame = 0;
    let phase = 1;

    const initialState = () => ({
      x: 310,
      y: 400,
      width: 20,
      height: 20,
      color: "red",
      speed: 4,
      hp: 92,
      maxHp: 92
    });

    let player = initialState();
    let attacks = [];
    let selectedSoul = null;
    let souls = [
      "Торриэль", "Санс", "Папирус", "Андайн", "Альфис", "Азгор"
    ];

    const keys = {};
    const dialog = [
      "Азриэль: Наконец-то мы снова встретились...",
      "Ты думаешь, что сможешь победить меня?",
      "Тогда покажи свою решимость!"
    ];
    let dialogIndex = 0;
    let showDialog = true;

    document.addEventListener("keydown", (e) => {
      keys[e.key] = true;
      if (e.key === "z" && showDialog) {
        dialogIndex++;
        if (dialogIndex >= dialog.length) {
          showDialog = false;
        }
      }
    });

    document.addEventListener("keyup", (e) => keys[e.key] = false);

    function resetGame() {
      player = initialState();
      attacks = [];
      dialogIndex = 0;
      showDialog = true;
      phase = 1;
      battleMusic.play();
      saveTheWorldMusic.pause();
    }

    function startPhaseTwo() {
      phase = 2;
      battleMusic.pause();
      saveTheWorldMusic.play();
    }

    function update() {
      if (!showDialog) {
        if (keys["ArrowLeft"] && player.x > 0) player.x -= player.speed;
        if (keys["ArrowRight"] && player.x + player.width < canvas.width) player.x += player.speed;
        if (keys["ArrowUp"] && player.y > 0) player.y -= player.speed;
        if (keys["ArrowDown"] && player.y + player.height < canvas.height) player.y += player.speed;

        frame++;
        if (frame % 60 === 0) {
          const rand = Math.random();
          if (rand < 0.33) {
            for (let i = 0; i < 5; i++) {
              attacks.push({ type: 'star', x: Math.random() * canvas.width, y: 0, size: 10, speedY: 2 + Math.random() * 2, color: 'cyan' });
            }
          } else if (rand < 0.66) {
            attacks.push({ type: 'laser', x: Math.random() * canvas.width, y: 0, width: 10, height: canvas.height, speedY: 1, duration: 60, color: 'magenta' });
          } else {
            for (let angle = 0; angle < 360; angle += 30) {
              const rad = angle * Math.PI / 180;
              attacks.push({ type: 'wave', x: player.x + player.width / 2, y: player.y + player.height / 2, vx: Math.cos(rad) * 3, vy: Math.sin(rad) * 3, size: 6, color: 'orange' });
            }
          }
        }

        attacks.forEach((a) => {
          if (a.type === 'star') a.y += a.speedY;
          else if (a.type === 'laser') a.duration--;
          else if (a.type === 'wave') { a.x += a.vx; a.y += a.vy; }
        });

        attacks.forEach((a) => {
          let hit = false;
          if (a.type === 'star' || a.type === 'wave') {
            if (player.x < a.x + a.size && player.x + player.width > a.x && player.y < a.y + a.size && player.y + player.height > a.y) hit = true;
          } else if (a.type === 'laser' && a.duration > 0) {
            if (player.x < a.x + a.width && player.x + player.width > a.x) hit = true;
          }
          if (hit && player.hp > 0) {
            player.hp -= 1;
            if (player.hp <= 0) {
              player.hp = 0;
              setTimeout(() => {
                resetGame();
              }, 1000);
            }
          }
        });
      }
    }

    function drawDialog() {
      ctx.fillStyle = "white";
      ctx.fillRect(50, 360, 540, 100);
      ctx.strokeStyle = "black";
      ctx.strokeRect(50, 360, 540, 100);
      ctx.fillStyle = "black";
      ctx.font = "16px Courier New";
      ctx.fillText(dialog[dialogIndex] || "", 60, 390);
      ctx.fillText("[Z] - Далее", 480, 445);
    }

    function drawHP() {
      ctx.fillStyle = "white";
      ctx.fillRect(10, 10, 100, 15);
      ctx.fillStyle = "green";
      ctx.fillRect(10, 10, 100 * (player.hp / player.maxHp), 15);
      ctx.strokeStyle = "black";
      ctx.strokeRect(10, 10, 100, 15);
      ctx.fillStyle = "white";
      ctx.font = "14px Courier New";
      ctx.fillText(`HP: ${player.hp}/${player.maxHp}`, 120, 22);
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      ctx.fillStyle = player.color;
      ctx.fillRect(player.x, player.y, player.width, player.height);

      attacks.forEach((a) => {
        ctx.fillStyle = a.color;
        if (a.type === 'star' || a.type === 'wave') ctx.fillRect(a.x, a.y, a.size, a.size);
        else if (a.type === 'laser' && a.duration > 0) ctx.fillRect(a.x, a.y, a.width, a.height);
      });

      drawHP();
      if (showDialog) drawDialog();
    }

    function gameLoop() {
      if (gameStarted) {
        update();
        draw();
        requestAnimationFrame(gameLoop);
      }
    }

    startButton.onclick = () => {
      startButton.style.display = "none";
      battleMusic.play();
      gameStarted = true;
      gameLoop();
    };

    // Call this function to transition to phase two after completing phase one
    setTimeout(() => {
      if (gameStarted) {
        startPhaseTwo(); // Transition to phase 2 after 10 seconds
      }
    }, 10000); // Adjust timing as necessary

  </script>
</body>
</html>
